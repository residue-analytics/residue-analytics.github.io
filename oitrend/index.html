<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OI Data Calculator">
    <title>OI Data Calculator</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/settings.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="/js/table.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/settings.js"></script>
</head>

<body>

    <div id="layout">

        <!-- Menu toggle -->
        <a href="#menu" id="menuLink" class="menu-link">
            <!-- Hamburger icon -->
            <span></span>
        </a>

        <div id="menu">
            <div class="pure-menu">
                <a class="pure-menu-heading" href="/index.html">Residue</a>

                <ul class="pure-menu-list">
                    <li class="pure-menu-item">
                        <a href="/range/index.html" class="pure-menu-link">Range Calc</a>
                    </li>
                    <li class="pure-menu-item">
                        <a href="/mwatch/index.html" class="pure-menu-link">Index Watch</a>
                    </li>
                    <li class="pure-menu-item">
                        <a href="/oitrend/index.html" class="pure-menu-link">OI Trend</a>
                    </li>

                    <li class="pure-menu-item"><a href="#" onclick="openSettings('OITrend')" class="pure-menu-link">Settings</a></li>
                    <li class="pure-menu-item"><a href="/contact/index.html" class="pure-menu-link">Contact Us</a></li>
                </ul>
            </div>
        </div>

        <div id="main">
            <div class="header">
                <h1>Nitin Murarka's OI Trend</h1>
                <!-- h2>A subtitle for your page goes here</h2 -->
            </div>

            <div class="content">
                <!-- h2 class="content-subhead">Utilities</h2-->
                <!-- input type="file" name="inputfile" id="inputfile" -->
                <div class="flex-container">
                    <div>
                        <select id="underlying" style="height:30px">
                            <option selected>NIFTY</option>
                            <option>BANKNIFTY</option>
                        </select>
                    </div>
                    <div><label id="underlyingPrice"></label></div>
                    <div><select id="expiry" style="width:120px; height:30px"></select></div>
                    <div><button type="button" style="background-color: #8CCCF1; height:30px;" onClick="getChain()">GO</button></div>
                    <div><label style="font-weight:bold">Market: </label><label id="market"></label></div>
                    <div>
                        <label style="font-weight:bold">Data as of:</label>
                        <label id="lastUpdateTime"></label>
                    </div>
                    <div><label style="font-weight:bold" for="duration">Refresh Duration (Mins) </label><input type="text" id="duration" style="width: 30px" value="5" onChange="updateDuration()"/></div>
                    <div><label style="font-weight:bold">Using </label><label id="strikeCount"></label><label style="font-weight:bold"> Strikes</label></div>
                    <div><button type="button" style="background-color: #ff0000; height:30px;" onClick="clearData()">RESET</button></div>
                </div>
                <div class="bar error" id="alert">
                    <div class="close" onclick="this.parentElement.remove()">X</div>
                    <i class="ico">&#9747;</i> Error message
                </div>
                <div id="settingsModal" class="modal"></div>
                <table id="oidata-table" class="display" style="width:100%">
                </table>

                <pre id="output"></pre>
            </div>
        </div>
    </div>

    <script src="/js/ui.js" page="base"></script>
    
    <script type="text/javascript">

        //document.getElementById('inputfile')
        //    .addEventListener('change', function() {
        //
        //    var fr=new FileReader();
        //    fr.onload=function() {
        //        document.getElementById('output').textContent=fr.result;
        //    }

        //   fr.readAsText(this.files[0]);
        //});

        var dataset = [];
        var dtable = null;
        var refDuration = 5;   // Minutes
        var interval = null;

        var worker = new Worker('/js/datafetch.js');

        $(document).ready(function (e) {

            dtable = dynamicTable.config('oidata-table',
                ['Time', 'CallOI', 'PutOI', 'Diff', 'Signal'],
                ['Time', 'Call OI', 'Put OI', 'Difference', 'Signal'],
                'Fetching the Data...');

            refDuration = getRefreshDuration();
            if (refDuration < 1000) refDuration = 1000;
            interval = setInterval(getChain, refDuration * 60 * 1000);

            getChain();
        });

        function getChain() {

            worker.postMessage(document.getElementById('underlying').value);
        }

        function updateDuration() {
            let dur = document.getElementById('duration').value;
            let paramNameDur = "RefreshDur" + document.getElementById('underlying').value;
            const oiTrendSettings = getSettingsData("OITrend");
            
            if (oiTrendSettings) {
                oiTrendSettings[paramNameDur] = dur;
            } else {
                oiTrendSettings = {
                    [paramNameDur]: dur
                };
            }
            saveSettingsData('OITrend', oiTrendSettings);
            refDuration = dur;
            clearInterval(interval);

            if (refDuration < 1000) refDuration = 1000;
            internal = setInterval(getChain, refDuration * 60 * 1000);
        }

        function getRefreshDuration() {
            let paramNameDur = "RefreshDur" + document.getElementById('underlying').value;
            const oiTrendSettings = getSettingsData("OITrend");
            if (oiTrendSettings && oiTrendSettings[paramNameDur]) {
                document.getElementById('duration').value = oiTrendSettings[paramNameDur];
                return oiTrendSettings[paramNameDur];
            }

            return document.getElementById('duration').value;
        }

        worker.onmessage = function (event) {
            if (event.data.status != 200) {
                alertMessage(event.data.message + "[" + event.data.status + "]");
                return;
            }

            dataset = event.data;
            // console.log(dataset);

            saveCurrentChain(dataset);

            document.getElementById('underlyingPrice').innerHTML = dataset["underlyingPrice"];
            document.getElementById('market').innerHTML = dataset["market"];
            document.getElementById('lastUpdateTime').innerHTML = dataset["lastUpdateTime"];

            let select = document.getElementById('expiry');
            let expirySel
            if (select.selectedIndex != -1) {
                expirySel = select.options[select.selectedIndex].text;
            } else {
                expirySel = dataset.expiries[0];
            }
            select.options.length = 0;   // Remove all child option nodes

            for (let i = 0; i < dataset.expiries.length; i++) {
                let optNode = document.createElement("option");
                optNode.innerText = dataset.expiries[i];
                if (dataset.expiries[i] == expirySel) {
                    optNode.selected = true;
                }
                select.appendChild(optNode);
            }

            let strikesToAdd = [];
            let paramNameSTA = "DisplayStrikes" + dataset.underlying;
            const oiTrendSettings = getSettingsData("OITrend");
            if (oiTrendSettings && oiTrendSettings[paramNameSTA]) {
                strikesToAdd = oiTrendSettings[paramNameSTA];
            }
            if (strikesToAdd.length == 0) {
                strikesToAdd = dataset.strikes;
            }
            document.getElementById('strikeCount').innerHTML = strikesToAdd.length;

            let prevOITrendData = [];
            prevOITrendData = getOITrendData(dataset.underlying, expirySel);
            if (prevOITrendData == null) {
                prevOITrendData = [];
            }

            let newTrendData = getTableData(dataset.allChains[expirySel], strikesToAdd);
            prevOITrendData.unshift(newTrendData);

            dtable.load(prevOITrendData);

            saveOITrendData(dataset.underlying, expirySel, prevOITrendData);
        };

        worker.onerror = function (err) {
            console.log(err);
            alertMessage(err);

            //alertMessage("Plain bar with no extras");
            //alertMessage("Information", 1, "&#8505;");
            //alertMessage("Success", 2, "&#9745;");
            //alertMessage("Warning", 3, "&#9888;");
        };

        function getTableData(selExpOptChn, strikesToAdd) {

            let dataObj = { Time: "", CallOI: 0, PutOI: 0, Diff: 0, Signal: "" };
            for (strike in selExpOptChn) {
                if (strikesToAdd.length >= 0 && !strikesToAdd.find((elem) => { return elem == strike })) {
                    continue;
                }

                let ce = selExpOptChn[strike]['CE'];
                let pe = selExpOptChn[strike]['PE']
                if (ce) {
                    dataObj.CallOI += ce["openInterest"];
                }

                if (pe) {
                    dataObj.PutOI += pe["openInterest"];
                }
            }

            dataObj.Time = new Date().toLocaleTimeString();
            dataObj.Diff = dataObj.PutOI - dataObj.CallOI;
            if (dataObj.Diff >= 0) {
                dataObj.Signal = "BUY";
            } else {
                dataObj.Signal = "SELL";
            }

            return dataObj;
        }

        function clearData() {
            let underlying = document.getElementById('underlying').value;
            let select = document.getElementById('expiry');
            let expirySel
            if (select.selectedIndex != -1) {
                expirySel = select.options[select.selectedIndex].text;
            }
            saveOITrendData(underlying, expirySel, []);
            getChain();
        }

        // https://code-boxx.com/simple-css-error-messages/
        function alertMessage(message) {
            // alertmessage() : enable a notification bar
            // message : notification message

            let alertNode = document.getElementById("alert");
            alertNode.innerHTML = message;
            alertNode.style.display = "block";
            setTimeout(function () {
                alertNode.style.display = 'none';
            }, 5000);
        }

    </script>
</body>

</html>