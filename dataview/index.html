<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

  <meta name="description" content="Data Viewer">
  <title>Data Viewer</title>
  
  <!--Plugin CSS file with desired skin-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css" />

  <!--jQuery-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!--Plugin JavaScript file-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>

  <script src="//cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js"></script>
  <script src="/js/classes.js"></script>
  <script src="/js/dbaccess.js"></script>
</head>

<body>

  <div id="main">
    <div class="container">
      <div class="row text-center">
        <h1>Data Viewer</h1>
        <!-- h2>A subtitle for your page goes here</h2 -->
      </div>


      <div class="row mb-3">
        <label class="visually-hidden" for="autocomplete">Freeform</label>
        <div class="input-group">
          <div class="input-group-text">@</div>
          <input class="form-control" id="autocomplete" list="autocompleteOptions" placeholder="Freeform Type">
          <datalist id="autocompleteOptions">
            <option value="San Francisco">
            <option value="New York">
          </datalist>
        </div>
      </div>

      <div class="row row-cols-md-4 g-3 align-items-center mb-3 justify-content-evenly">
        <div class="col-md visually-hidden">
          <div class="form-floating">
            <select class="form-select" id="exchange" onchange="updateLists(this.id, this.value)">
            </select>
            <label for="exchange">Exchange</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="instrument" onchange="updateLists(this.id, this.value)">
            </select>
            <label class="form-label" for="instrument">Instrument</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="underlying" onchange="updateLists(this.id, this.value)">
            </select>
            <label class="form-label" for="underlying">Underlying</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="expiries" onchange="updateLists(this.id, this.value)"></select>
            <label class="form-label" for="expiries">Expiry</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="strikes"></select>
            <label class="form-label" for="strikes">Strike Price</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="ce_pe">
              <option selected>CE</option>
              <option>PE</option>
            </select>
            <label class="form-label" for="ce_pe">Option Type</label>
          </div>
        </div>

        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" id="days" onchange="updateLists(this.id, this.value)"></select>
            <label class="form-label" for="days">Date</label>
          </div>
        </div>

          <div class="col-md">
            <button type="button" class="btn btn-primary" onclick="getRecords()">GO</button>
          </div>
        </div>

      <div class="row mb-3">
        <div>
          <input type="text" id="example_id" name="example_name" value="" />
        </div>
      </div>

      <div id="erroralert" class="row"></div>

      <div class="row">
        <div class="col-9">
          <input type="text" class="form-control mb-3" id="scriptevaluator" placeholder="Javascript">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary d-inline mb-3" onclick="evaluateScript()">GO</button>
        </div>

      </div>

      <hr />

      <pre class="text-break" style="white-space:normal" id="output"></pre>

    </div>
  </div>

    <script type="text/javascript">

      var worker = new Worker('js/dataworker.js');
      var cacheSyms = null;
      
      $("#example_id").ionRangeSlider({
        skin: "round",
        type: "double",
        grid: true,
        min: UIUtils.dateToTS(new Date("2021-01-01T09:15:00+05:30")),
        max: UIUtils.dateToTS(new Date("2021-01-01T15:30:00+05:30")),
        from: UIUtils.dateToTS(new Date("2021-01-01T12:00:00+05:30")),
        to: UIUtils.dateToTS(new Date("2021-01-01T13:00:00+05:30")),
        force_edges: true,
        prettify: UIUtils.tsToDate
      });

      // Initialize the dropdowns
      UIUtils.addSpinner("exchange");
      UIUtils.addSpinner("instrument");
      UIUtils.addSpinner("underlying");
      DBFacade.fetchLists().then(symList => {
        cacheSyms = symList;
        UIUtils.updSelectDropdown("exchange", symList.getAs());
        UIUtils.rmSpinner("exchange");
        let exc = document.getElementById("exchange").options[0].text;
        updateLists("exchange", exc);
        UIUtils.updAutocomplete(symList, "autocompleteOptions");
      });

      function evaluateScript() {
        console.log("Evaluating");
        let input = document.getElementById('scriptevaluator').value;
        let output = document.getElementById('output');
        data = eval(input);
        if (data instanceof Promise) {
          data.then(response => {
            output.innerHTML = JSON.stringify(response)
          }).catch(error => {
            UIUtils.showAlert("erroralert", error);
            output.innerHTML = JSON.stringify(error);
            console.log(error);
          });
        } else {
          output.innerHTML = data;
        }
      }

      function updateLists(selectID, selectedVal) {
        let excSel = instSel = ulySel = leaf = null;
        switch (selectID) {
          case "exchange":
            let exc = selectedVal;
            UIUtils.updSelectDropdown("instrument", cacheSyms.getBs(exc));
            let inst = document.getElementById("instrument").options[0].text;
            UIUtils.updSelectDropdown("underlying", Array.from(cacheSyms.getCs(exc, inst), val => val.c));
            UIUtils.rmSpinner("instrument");
            selectedVal = inst;  // For the next case, we are not break-ing
          case "instrument":
            excSel = document.getElementById("exchange");
            UIUtils.updSelectDropdown("underlying", Array.from(cacheSyms.getCs(excSel.options[excSel.selectedIndex].text, selectedVal), val => val.c));
            UIUtils.rmSpinner("underlying");
            selectedVal = document.getElementById("underlying").options[0].text;
          case "underlying":
            excSel = document.getElementById("exchange");
            instSel = document.getElementById("instrument");
            UIUtils.addSpinner("expiries");
            leaf = cacheSyms.getLeaf(excSel.options[excSel.selectedIndex].text, instSel.options[instSel.selectedIndex].text, selectedVal);
            DBFacade.fetchLists(leaf).then(data => {
              //console.log(data);
              if (data.days) {
                UIUtils.updSelectDropdown("days", data.days, datefmt = true);
                UIUtils.updateDatetimeSlider("example_id", "days");
              }
              if (data.exps) {
                UIUtils.updSelectDropdown("expiries", data.exps, datefmt = true);
                updateLists("expiries", data.exps[0]);
              }
              UIUtils.rmSpinner("expiries");
            }).catch(error => {
              console.log(error);
              UIUtils.rmSpinner("expiries");
              UIUtils.showAlert("erroralert", error);
            });

            break;
          case "expiries":
            excSel = document.getElementById("exchange");
            instSel = document.getElementById("instrument");
            ulySel = document.getElementById("underlying");

            UIUtils.addSpinner("strikes");
            UIUtils.addSpinner("days");
            leaf = cacheSyms.getLeaf(excSel.value, instSel.value, ulySel.value);

            DBFacade.fetchLists(leaf, selectedVal).then(data => {
              //console.log(data);
              if (data.days) {
                UIUtils.updSelectDropdown("days", data.days, datefmt = true);
              }
              if (data.stks) {
                UIUtils.updSelectDropdown("strikes", data.stks);
              }
              updateLists("days", data.days[0]);
              UIUtils.rmSpinner("strikes");
              UIUtils.rmSpinner("days");
              UIUtils.updateDatetimeSlider("example_id", "days");
            }).catch(error => {
              console.log(error);
              UIUtils.rmSpinner("strikes");
              UIUtils.rmSpinner("days");
              UIUtils.showAlert("erroralert", error);
            });
            break;
          case "days":
            UIUtils.updateDatetimeSlider("example_id", "days");
        }
      }

      function getRecords() {
        let output = document.getElementById('output');
        let rangeSlider = $("#example_id").data('ionRangeSlider');

        DBFacade.fetchRecs(document.getElementById("exchange").value, document.getElementById("instrument").value,
          document.getElementById("underlying").value, document.getElementById("expiries").value,
          null, [document.getElementById("strikes").value], [document.getElementById("ce_pe").value],
          Math.floor(rangeSlider.result.from / 60000) * 60, Math.floor(rangeSlider.result.to / 60000) * 60
        ).then(response => {
            output.innerHTML = JSON.stringify(response);
          }).catch(error => {
            output.innerHTML = JSON.stringify(error);
            console.log(error);
            UIUtils.showAlert("erroralert", error);
          });
      }

      worker.onmessage = function (event) {
        if (event.data.status != 200) {
          alertMessage(event.data.message + "[" + event.data.status + "]");
          return;
        }
      }

      worker.onerror = function (err) {
        console.log(err);
        alertMessage(err);
      };

      function processResponse() {
        if (xhr.readyState == 4) {
          if (xhr.status == 200) {
            jsonObj = JSON.parse(xhr.responseText);
          } else {
            if (xhr.status == 0) {
              alertMessage(xhr.status, "Non-HTTP Error: " + xhr.statusText)
            } else {
              alertMessage(xhr.status, xhr.statusText);
            }
          }
        }
      }

      function clearData() {
        let underlying = document.getElementById('underlying').value;
        let select = document.getElementById('expiry');
        let expirySel
        if (select.selectedIndex != -1) {
          expirySel = select.options[select.selectedIndex].text;
        }
        saveOITrendDataStore(underlying, expirySel, []);
        getChain();
      }

      // https://code-boxx.com/simple-css-error-messages/
      function alertMessage(message) {
        // alertmessage() : enable a notification bar
        // message : notification message

        let alertNode = document.getElementById("alert");
        alertNode.innerHTML = message;
        alertNode.style.display = "block";
        setTimeout(function () {
          alertNode.style.display = 'none';
        }, 5000);
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js" integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj" crossorigin="anonymous"></script>

</body>

</html>